// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  avatarUrl    String?  @map("avatar_url")
  isAdmin      Boolean  @default(false) @map("is_admin")
  createdAt    DateTime @default(now()) @map("created_at")
  rating       Decimal  @default(0.0) @db.Decimal(3, 2)
  reviewsCount Int      @default(0) @map("reviews_count")

  // Relations
  computers        Computer[]
  bookingsAsRenter Booking[]  @relation("RenterBookings")
  sentMessages     Message[]  @relation("SentMessages")
  receivedMessages Message[]  @relation("ReceivedMessages")
  reviewsGiven     Review[]   @relation("ReviewsGiven")
  reviewsReceived  Review[]   @relation("ReviewsReceived")

  @@map("users")
}

model Computer {
  id            Int     @id @default(autoincrement())
  userId        Int     @map("user_id")
  name          String
  description   String? @db.Text
  category      String?
  pricePerHour  Decimal @map("price_per_hour") @db.Decimal(10, 2)
  cpu           String?
  gpu           String?
  ram           Int?
  storage       String?
  os            String? @db.VarChar(100)
  internetSpeed String? @map("internet_speed") @db.VarChar(50)
  status        String  @default("active") @db.VarChar(20)

  // Approval System
  isApproved Boolean   @default(false) @map("is_approved")
  approvedAt DateTime? @map("approved_at")
  approvedBy String?   @map("approved_by") @db.VarChar(255)

  // Remote Access Configuration
  rdpHost        String? @map("rdp_host")
  rdpPort        Int?    @default(3389) @map("rdp_port")
  vncPort        Int?    @map("vnc_port")
  accessPassword String? @map("access_password") // Encrypted
  accessMethod   String? @default("rdp") @map("access_method") // rdp, vnc, chrome-remote
  remoteId       String? @map("remote_id") // For Chrome Remote Desktop or similar

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  images   ComputerImage[]
  bookings Booking[]
  messages Message[]

  @@map("computers")
}

model ComputerImage {
  id         Int     @id @default(autoincrement())
  computerId Int     @map("computer_id")
  imageUrl   String  @map("image_url") @db.VarChar(500)
  isPrimary  Boolean @default(false) @map("is_primary")

  // Relations
  computer Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)

  @@map("computer_images")
}

model Booking {
  id                  Int       @id @default(autoincrement())
  computerId          Int       @map("computer_id")
  renterId            Int       @map("renter_id")
  startTime           DateTime? @map("start_time")
  endTime             DateTime? @map("end_time")
  status              String    @db.VarChar(20) // pending, active, completed, cancelled
  priceAgreed         Decimal   @map("price_agreed") @db.Decimal(10, 2)
  actualDurationHours Decimal?  @map("actual_duration_hours") @db.Decimal(10, 2)
  totalPrice          Decimal?  @map("total_price") @db.Decimal(10, 2)

  // Payment
  stripePaymentIntentId String? @map("stripe_payment_intent_id")
  paymentStatus         String? @default("pending") @map("payment_status") // pending, paid, refunded

  // Remote Access
  guacamoleConnectionId String? @map("guacamole_connection_id")
  accessToken           String? @map("access_token") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  computer Computer @relation(fields: [computerId], references: [id])
  renter   User     @relation("RenterBookings", fields: [renterId], references: [id])
  reviews  Review[]

  @@map("bookings")
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int      @map("sender_id")
  receiverId Int      @map("receiver_id")
  computerId Int?     @map("computer_id")
  message    String   @db.Text
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  sender   User      @relation("SentMessages", fields: [senderId], references: [id])
  receiver User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  computer Computer? @relation(fields: [computerId], references: [id])

  @@map("messages")
}

model Review {
  id         Int      @id @default(autoincrement())
  bookingId  Int      @map("booking_id")
  reviewerId Int      @map("reviewer_id")
  revieweeId Int      @map("reviewee_id")
  rating     Int // 1-5
  comment    String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  booking  Booking @relation(fields: [bookingId], references: [id])
  reviewer User    @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewee User    @relation("ReviewsReceived", fields: [revieweeId], references: [id])

  @@map("reviews")
}
