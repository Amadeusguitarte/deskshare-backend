<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi√≥n Remota - DeskShare</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .remote-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .remote-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .session-info {
            color: white;
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .session-timer {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .session-cost {
            font-size: 1.2rem;
        }

        .remote-controls {
            display: flex;
            gap: 15px;
        }

        .btn-end {
            background: #ff4444;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .parsec-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            position: relative;
        }

        #parsecVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .connection-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 15px;
        }

        .status-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .status-text {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .connection-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            color: white;
            max-width: 600px;
            margin: 20px auto;
        }

        .parsec-code {
            background: rgba(102, 126, 234, 0.2);
            padding: 20px;
            border-radius: 8px;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 20px 0;
            border: 2px dashed #667eea;
        }

        .step-list {
            text-align: left;
            margin: 20px 0;
        }

        .step-list li {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }

        .step-list li::before {
            content: "‚ñ∂";
            position: absolute;
            left: 0;
            color: #667eea;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .connecting {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div class="remote-container">
        <!-- Header with session info -->
        <div class="remote-header">
            <div class="session-info">
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Sesi√≥n Activa</div>
                    <div id="computerName" style="font-size: 1.2rem; font-weight: 700;">Loading...</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Tiempo Transcurrido</div>
                    <div class="session-timer" id="sessionTimer">00:00:00</div>
                </div>
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Costo Actual</div>
                    <div class="session-cost" id="sessionCost">$0.00</div>
                </div>
            </div>
            <div class="remote-controls">
                <button class="btn-end" onclick="endSession()">Finalizar Sesi√≥n</button>
            </div>
        </div>

        <!-- Parsec Display Area -->
        <div class="parsec-display">
            <!-- This will be replaced with actual Parsec Web SDK when available -->
            <video id="parsecVideo" style="display: none;"></video>
            <audio id="parsecAudio" style="display: none;"></audio>

            <!-- Connection Instructions (shown until Parsec connects) -->
            <div id="connectionInstructions" class="connection-instructions">
                <div class="status-icon">üñ•Ô∏è</div>
                <h2>Conectar via Parsec</h2>

                <div class="status-text" id="statusText">Iniciando sesi√≥n...</div>

                <div id="parsecInfo" style="display: none;">
                    <p><strong>C√≥digo de Acceso Parsec:</strong></p>
                    <div class="parsec-code" id="parsecCode">------</div>

                    <ol class="step-list">
                        <li>Descarga e instala <a href="https://parsec.app/downloads" target="_blank"
                                style="color: #667eea;">Parsec App</a> si no la tienes</li>
                        <li>Abre Parsec en tu computadora</li>
                        <li>Ve a "Connect" ‚Üí "Connect to Peer"</li>
                        <li>Ingresa el c√≥digo de acceso de arriba</li>
                        <li>¬°Disfruta tu sesi√≥n!</li>
                    </ol>

                    <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.7;">
                        <strong>Nota:</strong> Por ahora, Parsec requiere su aplicaci√≥n nativa para la mejor
                        experiencia.
                        La integraci√≥n web directa est√° en desarrollo.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let booking = null;
        let startTime = null;
        let timerInterval = null;
        let pricePerHour = 0;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            redirectIfNotLoggedIn();

            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            if (!bookingId) {
                alert('ID de booking inv√°lido');
                window.location.href = 'marketplace.html';
                return;
            }

            await initializeSession(bookingId);
        });

        async function initializeSession(bookingId) {
            try {
                // Get booking details
                const bookingResponse = await apiRequest(`/bookings/${bookingId}`);
                booking = bookingResponse.booking || bookingResponse;

                // Update UI
                document.getElementById('computerName').textContent = booking.computer?.name || 'Computadora';
                pricePerHour = booking.priceAgreed;

                // Start the session on backend
                await apiRequest(`/bookings/${bookingId}/start`, {
                    method: 'POST'
                });

                startTime = new Date();
                startTimer();

                // Get Parsec session info
                await setupParsecConnection(bookingId);

            } catch (error) {
                console.error('Error initializing session:', error);
                alert('Error al iniciar la sesi√≥n: ' + error.message);
                window.location.href = 'profile.html';
            }
        }

        async function setupParsecConnection(bookingId) {
            try {
                document.getElementById('statusText').textContent = 'Obteniendo credenciales de Parsec...';

                // In production, this would call the Parsec Teams API
                // For now, we'll show instructions for manual connection
                const parsecSession = {
                    peerID: `peer-${booking.computerId}`,
                    accessCode: generateDemoAccessCode()
                };

                // Show Parsec instructions
                document.getElementById('parsecCode').textContent = parsecSession.accessCode;
                document.getElementById('parsecInfo').style.display = 'block';
                document.getElementById('statusText').textContent = 'Listo para conectar';

                // TODO: Integrate actual Parsec Web SDK when available
                // This would involve:
                // 1. Loading Parsec SDK
                // 2. Creating client with video/audio elements
                // 3. Calling client.connect(sessionId, peerId)

            } catch (error) {
                console.error('Error setting up Parsec:', error);
                document.getElementById('statusText').textContent = 'Error al conectar con Parsec';
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;

                // Format time
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);

                document.getElementById('sessionTimer').textContent =
                    `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                // Calculate cost
                const hoursElapsed = elapsed / 3600000;
                const cost = hoursElapsed * pricePerHour;
                document.getElementById('sessionCost').textContent = `$${cost.toFixed(2)}`;

            }, 1000);
        }

        async function endSession() {
            if (!confirm('¬øEst√°s seguro de que quieres finalizar la sesi√≥n?')) {
                return;
            }

            try {
                clearInterval(timerInterval);

                // End session on backend
                const response = await apiRequest(`/bookings/${booking.id}/end`, {
                    method: 'POST'
                });

                const finalCost = response.booking.totalPrice || 0;
                const duration = response.duration || 0;

                alert(
                    `Sesi√≥n finalizada\n\n` +
                    `Duraci√≥n: ${duration.toFixed(2)} horas\n` +
                    `Costo total: $${finalCost.toFixed(2)}\n\n` +
                    `Ser√°s redirigido a tu perfil.`
                );

                window.location.href = 'profile.html';

            } catch (error) {
                alert('Error al finalizar sesi√≥n: ' + error.message);
            }
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function generateDemoAccessCode() {
            // Generate random 6-digit code for demo
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Prevent accidental page close
        window.addEventListener('beforeunload', (e) => {
            if (timerInterval) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>

</html>