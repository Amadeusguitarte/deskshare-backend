<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi贸n Remota - DeskShare</title>
    <!-- Guacamole Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/guacamole-common-js@1.4.0/dist/guacamole-common.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .remote-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .remote-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
        }

        .session-info {
            color: white;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .toggle-container {
            background: #333;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-purple);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-end {
            background: #ff4444;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end:hover {
            background: #cc0000;
        }

        /* DISPLAY AREAS */
        .workspace {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* GUACAMOLE */
        #guacamole-view {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: none;
            /* Hide cursor when interacting */
        }

        #display {
            /* Canvas container */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* PARSEC */
        #parsec-view {
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .connection-instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 10px;
            color: white;
            max-width: 600px;
            text-align: center;
            border: 1px solid #333;
        }

        .parsec-code {
            background: rgba(102, 126, 234, 0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 20px 0;
            border: 1px dashed #667eea;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="remote-container">
        <!-- Header -->
        <div class="remote-header">
            <div class="session-info">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size: 0.8rem; opacity: 0.7;">Conectado a</span>
                    <strong id="computerName">Cargando...</strong>
                </div>

                <div class="toggle-container">
                    <button class="toggle-btn active" onclick="switchMode('native')" id="btn-native">Nativo
                        (Web)</button>
                    <button class="toggle-btn" onclick="switchMode('parsec')" id="btn-parsec">Parsec (Ultra
                        Fluido)</button>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <div style="text-align: right; color: #ccc;">
                    <div style="font-size: 0.8rem;">Tiempo</div>
                    <div id="sessionTimer" style="font-weight: 700; color:white;">00:00:00</div>
                </div>
                <button class="btn-end" onclick="endSession()">Desconectar</button>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace">

            <!-- VIEW 1: GUACAMOLE (Default) -->
            <div id="guacamole-view">
                <div id="display"></div>
            </div>

            <!-- VIEW 2: PARSEC -->
            <div id="parsec-view">
                <div class="connection-instructions">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h2>Modo Alto Rendimiento</h2>
                    <p style="opacity: 0.7;">Ideal para gaming o edici贸n de video usando la app de Parsec.</p>

                    <div id="parsecInfo" style="display: none; margin-top: 20px;">
                        <p>C贸digo de Acceso:</p>
                        <div class="parsec-code" id="parsecCode">---</div>
                        <p><a href="https://parsec.app/" target="_blank" style="color: var(--accent-purple);">Abrir
                                Parsec App</a></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let booking = null;
        let startTime = null;
        let timerInterval = null;
        let pricePerHour = 0;

        // Guacamole Vars
        let guacClient = null;
        let guacDisplay = null;
        let mouse = null;
        let keyboard = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return; // script.js function

            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            if (!bookingId) {
                alert('ID de booking inv谩lido');
                window.location.href = 'marketplace.html';
                return;
            }

            await initializeSession(bookingId);
        });

        async function initializeSession(bookingId) {
            try {

                // DEBUG: Direct fetch to bypass cache/script.js issues
                const token = localStorage.getItem('authToken');
                const backendUrl = 'https://deskshare-backend-production.up.railway.app/api';

                const response = await fetch(`${backendUrl}/bookings/${bookingId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // SHOW FULL ERROR JSON
                    alert(`DEBUG ERROR:\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`);
                    // Don't redirect immediately so user can read
                    return;
                }

                // Success flow
                booking = data.booking;
                const guacToken = data.guacamoleToken;

                // Update UI
                document.getElementById('computerName').textContent = booking.computer?.name || 'PC Remota';
                pricePerHour = booking.priceAgreed;
                startTime = new Date(); // Reset timer to now
                startTimer();

                // 2. Initialize Guacamole if token exists
                if (guacToken) {
                    connectGuacamole(guacToken);
                } else {
                    // If no token (maybe no RDP configured), switch to Parsec
                    alert('No se detect贸 configuraci贸n RDP. Cambiando a modo Parsec.');
                    switchMode('parsec');
                }

                // 3. Setup Parsec Info (Just in case user switches)
                if (booking.computer?.parsecPeerId) {
                    document.getElementById('parsecCode').textContent = booking.accessToken ? 'Ver en Chat' : 'Auto-Connect';
                    document.getElementById('parsecInfo').style.display = 'block';
                }

            } catch (error) {
                console.error('Critical Session Error:', error);
                alert('Critical Error: ' + error.message);
            }
        }

        // ========================================
        // Guacamole Logic
        // ========================================
        function connectGuacamole(token) {
            const displayContainer = document.getElementById('display');

            // Create Tunnel
            // We use HTTPTunnel or WebSocketTunnel. standard guacamole-lite uses WebSocket at the path we defined.
            // Our backend path is attached to server, so 'ws://HOST/guacamole'
            // We must pass the token in the query string or protocol. guacamole-lite connection options usually expect a query param.

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const tunnelUrl = `${protocol}//${window.location.host}/guacamole`;

            // IMPORTANT: guacamole-common-js tunnel constructor is different depending on version.
            // For WebSocketTunnel, we pass the URL.
            // But we need to pass the TOKEN. guacamole-lite reads 'token' from query string.
            const tunnel = new Guacamole.WebSocketTunnel(`${tunnelUrl}?token=${token}`);

            // Create Client
            guacClient = new Guacamole.Client(tunnel);

            // Error handlers
            guacClient.onerror = function (error) {
                console.error('Guacamole Client Error:', error);
                const msg = error.message || error.toString();
                // Show error on screen
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:red">Error: ${msg}</div>`;
                alert('Guacamole Error: ' + msg);
            };

            // State Change Handler
            guacClient.onstatechange = function (state) {
                const states = {
                    0: 'IDLE',
                    1: 'CONNECTING',
                    2: 'WAITING',
                    3: 'CONNECTED',
                    4: 'DISCONNECTING',
                    5: 'DISCONNECTED'
                };
                const stateStr = states[state] || state;
                console.log('Guacamole State:', stateStr);

                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div>State: ${stateStr}</div>`;

                if (state === 3) { // CONNECTED
                    debugOverlay.style.display = 'none'; // Hide debug on success
                }
            };

            // Get Display
            guacDisplay = guacClient.getDisplay();
            const element = guacDisplay.getElement();
            displayContainer.appendChild(element);

            // Connect
            guacClient.connect();

            // === INPUT HANDLING ===
            // ... (rest of input handling)

            function createDebugOverlay() {
                const div = document.createElement('div');
                div.id = 'debug-overlay';
                div.style.cssText = 'position:fixed; top:60px; left:10px; background:rgba(0,0,0,0.8); color:#0f0; padding:10px; border:1px solid #0f0; font-family:monospace; z-index:9999; max-width:300px; pointer-events:none;';
                document.body.appendChild(div);
                return div;
            }

            // Mouse
            mouse = new Guacamole.Mouse(element);
            mouse.onmousedown = mouse.onmouseup = mouse.onmousemove = function (mouseState) {
                // Scale mouse events if display is scaled (TODO: Auto-scale logic)
                guacClient.sendMouseState(mouseState);
            };

            // Keyboard
            keyboard = new Guacamole.Keyboard(document);
            keyboard.onkeydown = function (keysym) {
                guacClient.sendKeyEvent(1, keysym);
            };
            keyboard.onkeyup = function (keysym) {
                guacClient.sendKeyEvent(0, keysym);
            };

            // Handle window focus for keyboard
            window.onblur = function () { keyboard.reset(); };

            // Resize listener (Basic)
            window.addEventListener('resize', () => {
                // Trigger display resize? 
                // For simplified V1, we rely on browser scaling or server side.
            });
        }

        // ========================================
        // UI Logic
        // ========================================
        function switchMode(mode) {
            const guacView = document.getElementById('guacamole-view');
            const parsecView = document.getElementById('parsec-view');
            const btnNative = document.getElementById('btn-native');
            const btnParsec = document.getElementById('btn-parsec');

            if (mode === 'native') {
                guacView.style.display = 'flex';
                parsecView.style.display = 'none';
                btnNative.classList.add('active');
                btnParsec.classList.remove('active');
                // Re-focus keyboard
                if (keyboard) keyboard.reset();
            } else {
                guacView.style.display = 'none';
                parsecView.style.display = 'flex';
                btnNative.classList.remove('active');
                btnParsec.classList.add('active');
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;

                const date = new Date(elapsed);
                const h = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
                const m = String(date.getUTCMinutes()).padStart(2, '0');
                const s = String(date.getUTCSeconds()).padStart(2, '0');

                document.getElementById('sessionTimer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        async function endSession() {
            if (!confirm('驴Terminar sesi贸n?')) return;

            try {
                if (guacClient) guacClient.disconnect();

                await apiRequest(`/bookings/${booking.id}/end`, { method: 'POST' });
                window.location.href = 'profile.html';
            } catch (e) {
                console.error(e);
                window.location.href = 'profile.html';
            }
        }

        // Cleanup
        window.onbeforeunload = function () {
            if (guacClient) guacClient.disconnect();
        };

    </script>
</body>

</html>