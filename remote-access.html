<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi贸n Remota - DeskShare</title>
    <!-- Guacamole Client Library - v1.3.0 for guacamole-lite 1.2.0 compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/guacamole-common-js@1.3.0/dist/guacamole-common.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .remote-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .remote-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
        }

        .session-info {
            color: white;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .toggle-container {
            background: #333;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-purple);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-end {
            background: #ff4444;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end:hover {
            background: #cc0000;
        }

        /* DISPLAY AREAS */
        .workspace {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* GUACAMOLE */
        #guacamole-view {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: none;
            /* Hide cursor when interacting */
        }

        #display {
            /* Canvas container */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* PARSEC */
        #parsec-view {
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .connection-instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 10px;
            color: white;
            max-width: 600px;
            text-align: center;
            border: 1px solid #333;
        }

        .parsec-code {
            background: rgba(102, 126, 234, 0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 20px 0;
            border: 1px dashed #667eea;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="remote-container">
        <!-- Header -->
        <div class="remote-header">
            <div class="session-info">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size: 0.8rem; opacity: 0.7;">Conectado a</span>
                    <strong id="computerName">Cargando...</strong>
                </div>

                <div class="toggle-container">
                    <button class="toggle-btn active" onclick="switchMode('native')" id="btn-native">Nativo</button>
                    <button class="toggle-btn" onclick="switchMode('rustdesk')" id="btn-rustdesk"
                        style="display:none;">RustDesk (P2P)</button>
                    <button class="toggle-btn" onclick="switchMode('parsec')" id="btn-parsec">Parsec</button>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <!-- LATENCY PANEL -->
                <div id="latency-panel"
                    style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px;">
                    <div id="latency-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #00ff00;">
                    </div>
                    <div style="text-align: center; color: #ccc;">
                        <div style="font-size: 0.7rem; opacity: 0.7;">Latencia</div>
                        <div id="latency-value" style="font-weight: 700; color: white; font-size: 0.9rem;">-- ms</div>
                    </div>
                </div>

                <div style="text-align: right; color: #ccc;">
                    <div style="font-size: 0.8rem;">Tiempo</div>
                    <div id="sessionTimer" style="font-weight: 700; color:white;">00:00:00</div>
                </div>
                <button class="btn-end" onclick="endSession()">Desconectar</button>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace">

            <!-- VIEW 1: GUACAMOLE (Default) -->
            <div id="guacamole-view">
                <div id="display"></div>
            </div>

            <!-- VIEW 2: PARSEC -->
            <div id="parsec-view">
                <div class="connection-instructions">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h2>Modo Alto Rendimiento</h2>
                    <p style="opacity: 0.7;">Ideal para gaming o edici贸n de video usando la app de Parsec.</p>

                    <div id="parsecInfo" style="display: none; margin-top: 20px;">
                        <p>C贸digo de Acceso:</p>
                        <div class="parsec-code" id="parsecCode">---</div>
                        <p><a href="https://parsec.app/" target="_blank" style="color: var(--accent-purple);">Abrir
                                Parsec App</a></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let booking = null;
        let startTime = null;
        let timerInterval = null;
        let pricePerHour = 0;

        // Guacamole Vars
        let guacClient = null;
        let guacDisplay = null;
        let mouse = null;
        let keyboard = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return; // script.js function

            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            if (!bookingId) {
                alert('ID de booking inv谩lido');
                window.location.href = 'marketplace.html';
                return;
            }

            await initializeSession(bookingId);
        });

        async function initializeSession(bookingId) {
            try {

                // DEBUG: Direct fetch to bypass cache/script.js issues
                const token = localStorage.getItem('authToken');
                const backendUrl = 'https://deskshare-backend-production.up.railway.app/api';

                const response = await fetch(`${backendUrl}/bookings/${bookingId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // SHOW FULL ERROR JSON
                    alert(`DEBUG ERROR:\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`);
                    // Don't redirect immediately so user can read
                    return;
                }

                // Success flow
                booking = data.booking;
                window.currentBooking = booking; // Store for mode switching

                // DEBUG: Show Connection Strategy
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:yellow; border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px;">Strategy: ${data.connectionStrategy}</div>`;
                if (data.connectionDebug) {
                    debugOverlay.innerHTML += `<div style="font-size:0.8rem; color:#888;">${data.connectionDebug}</div>`;
                }

                // Update UI
                document.getElementById('computerName').textContent = booking.computer?.name || 'PC Remota';
                pricePerHour = booking.priceAgreed;
                startTime = new Date(); // Reset timer to now
                startTimer();

                // === CHECK FOR RUSTDESK (P2P - LOW LATENCY) ===
                const rustdeskId = booking.computer?.rustdeskId;
                const rustdeskPassword = booking.computer?.rustdeskPassword;

                if (rustdeskId) {
                    console.log('[RUSTDESK] P2P connection available:', rustdeskId);

                    // SHOW BUTTON
                    const btnRustdesk = document.getElementById('btn-rustdesk');
                    if (btnRustdesk) btnRustdesk.style.display = 'flex'; // Or inline-flex

                    const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                    debugOverlay.innerHTML += `<div style="color:lime;"> RustDesk P2P: ${rustdeskId}</div>`;

                    // Try to connect via RustDesk
                    connectRustDesk(rustdeskId, rustdeskPassword);
                    // allow fallback to run? No, we need to choose one.
                    // For now, let's NOT return, but let the user choose. 
                    // Actually, simpler: Let's make RustDesk a "Mode" like Native/Parsec.

                    // But to respect user request "deja la de guacamole funcionando":
                    // We will NOT return here. We will let Guacamole load, but maybe overlay RustDesk info?
                    // Or better: Only use RustDesk if mode selected?

                    // Let's CHANGE strategy:
                    // If RustDesk exists, we show a notification but let Guacamole load as default for now
                    // UNLESS we want to force P2P.
                    // User said "Guacamole no funciona".

                    // Let's COMMENT OUT the return for now, so Guacamole loads, 
                    // and we just show RustDesk as an option/overlay.
                    // return; 
                }

                // === FALLBACK: GUACAMOLE (VNC/RDP) ===
                const guacToken = data.guacamoleToken;
                if (guacToken) {
                    // Show small notification about upgrade
                    const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                    debugOverlay.innerHTML += `
                        <div style="background: rgba(102, 126, 234, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #667eea;">
                            <strong style="color: #fff;"> Tip:</strong> Baja latencia disponible.<br>
                            <a href="https://deskshare-backend-production.up.railway.app/downloads/DeskShareSetup.exe" target="_blank" style="color: #667eea;">Descargar Nuevo Launcher</a> para usar modo R谩pido.
                        </div>
                    `;

                    connectGuacamole(guacToken);
                } else {
                    // If no token (maybe no RDP configured), switch to Parsec
                    alert('No se detect贸 configuraci贸n RDP/VNC. Cambiando a modo Parsec.');
                    switchMode('parsec');
                }

                // 3. Setup Parsec Info (Just in case user switches)
                if (booking.computer?.parsecPeerId) {
                    document.getElementById('parsecCode').textContent = booking.accessToken ? 'Ver en Chat' : 'Auto-Connect';
                    document.getElementById('parsecInfo').style.display = 'block';
                }

            } catch (error) {
                console.error('Critical Session Error:', error);
                alert('Critical Error: ' + error.message);
            }
        }

        // ========================================
        // RustDesk P2P Connection
        // ========================================
        function connectRustDesk(rustdeskId, password) {
            const displayContainer = document.getElementById('display');

            // Show connection info
            displayContainer.innerHTML = `
                <div style="text-align: center; color: white; padding: 40px;">
                    <h2> Conectando via RustDesk P2P</h2>
                    <p style="opacity: 0.7;">Latencia ultra-baja (~20-50ms)</p>
                    <div style="background: rgba(0,255,0,0.1); border: 1px solid #0f0; border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 400px;">
                        <p style="margin: 0 0 10px 0;">ID: <strong>${rustdeskId}</strong></p>
                        <p style="margin: 0;">Password: <strong>${password || 'Auto'}</strong></p>
                    </div>
                    <p style="font-size: 0.9rem; opacity: 0.7;">Abriendo RustDesk...</p>
                    <button onclick="openRustDeskApp('${rustdeskId}', '${password}')" 
                            style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 10px;">
                        Abrir RustDesk App
                    </button>
                    <div style="margin-top: 20px;">
                        <a href="https://rustdesk.com/download" target="_blank" style="color: #667eea; font-size: 0.9rem;">
                            驴No tienes RustDesk? Descargar aqu铆
                        </a>
                    </div>
                </div>
            `;

            // Try to open RustDesk automatically
            setTimeout(() => {
                openRustDeskApp(rustdeskId, password);
            }, 1500);
        }

        function openRustDeskApp(rustdeskId, password) {
            // RustDesk protocol handler
            const rustdeskUrl = `rustdesk://connection/new/${rustdeskId}${password ? '?password=' + encodeURIComponent(password) : ''}`;
            console.log('[RUSTDESK] Opening:', rustdeskUrl);

            // Try to open
            window.location.href = rustdeskUrl;
        }

        // ========================================
        // Guacamole Logic
        // ========================================
        function connectGuacamole(token) {
            const displayContainer = document.getElementById('display');

            // Create Tunnel
            // We use HTTPTunnel or WebSocketTunnel. standard guacamole-lite uses WebSocket at the path we defined.
            // Our backend path is attached to server, so 'ws://HOST/guacamole'
            // We must pass the token in the query string or protocol. guacamole-lite connection options usually expect a query param.

            // FIX: Point to Backend, not Frontend (Netlify)
            // const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // const tunnelUrl = `${protocol}//${window.location.host}/guacamole`;

            // Hardcoded Backend for Production (Railway)
            const tunnelUrl = 'wss://deskshare-backend-production.up.railway.app/guacamole';

            // IMPORTANT: guacamole-common-js tunnel constructor is different depending on version.
            // For WebSocketTunnel, we pass the URL.
            // But we need to pass the TOKEN. guacamole-lite reads 'token' from query string.
            const tunnel = new Guacamole.WebSocketTunnel(`${tunnelUrl}?token=${token}`);

            // Create Client
            guacClient = new Guacamole.Client(tunnel);

            // Error handlers
            guacClient.onerror = function (error) {
                console.error('Guacamole Client Error:', error);
                const msg = error.message || error.toString();
                // Show error on screen
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:red">Error: ${msg}</div>`;
                alert('Guacamole Error: ' + msg);
            };

            // State Change Handler
            guacClient.onstatechange = function (state) {
                const states = {
                    0: 'IDLE',
                    1: 'CONNECTING',
                    2: 'WAITING',
                    3: 'CONNECTED',
                    4: 'DISCONNECTING',
                    5: 'DISCONNECTED'
                };
                const stateStr = states[state] || state;
                console.log('Guacamole State:', stateStr);

                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div>State: ${stateStr}</div>`;

                if (state === 3) { // CONNECTED
                    debugOverlay.style.display = 'none'; // Hide debug on success
                }
            };

            // Get Display
            guacDisplay = guacClient.getDisplay();
            const element = guacDisplay.getElement();
            displayContainer.appendChild(element);

            // === CRITICAL: Handle display sync/updates ===
            let syncCount = 0;
            guacClient.onsync = function () {
                syncCount++;
                // Called when display updates
                const displayWidth = guacDisplay.getWidth();
                const displayHeight = guacDisplay.getHeight();

                // Log every 10th sync to avoid spam
                if (syncCount === 1 || syncCount % 10 === 0) {
                    console.log(`[GUAC] onsync #${syncCount} - Display: ${displayWidth}x${displayHeight}`);
                }

                if (displayWidth > 0 && displayHeight > 0) {
                    // Auto-scale to fit container
                    const containerWidth = displayContainer.offsetWidth;
                    const containerHeight = displayContainer.offsetHeight;
                    const scaleX = containerWidth / displayWidth;
                    const scaleY = containerHeight / displayHeight;
                    const scale = Math.min(scaleX, scaleY, 1);
                    guacDisplay.scale(scale);
                }
            };

            // Connect
            guacClient.connect();

            // === INPUT HANDLING ===
            // ... (rest of input handling)



            // Mouse
            mouse = new Guacamole.Mouse(element);
            mouse.onmousedown = mouse.onmouseup = mouse.onmousemove = function (mouseState) {
                // Scale mouse events if display is scaled
                const scale = guacDisplay.getScale();
                mouseState.x = mouseState.x / scale;
                mouseState.y = mouseState.y / scale;
                guacClient.sendMouseState(mouseState);
            };

            // Keyboard
            keyboard = new Guacamole.Keyboard(document);
            keyboard.onkeydown = function (keysym) {
                guacClient.sendKeyEvent(1, keysym);
            };
            keyboard.onkeyup = function (keysym) {
                guacClient.sendKeyEvent(0, keysym);
            };

            // Handle window focus for keyboard
            window.onblur = function () { keyboard.reset(); };

            // Resize listener (Auto-scale on window resize)
            window.addEventListener('resize', () => {
                if (guacDisplay && guacDisplay.getWidth() > 0) {
                    const containerWidth = displayContainer.offsetWidth;
                    const containerHeight = displayContainer.offsetHeight;
                    const displayWidth = guacDisplay.getWidth();
                    const displayHeight = guacDisplay.getHeight();
                    const scaleX = containerWidth / displayWidth;
                    const scaleY = containerHeight / displayHeight;
                    const scale = Math.min(scaleX, scaleY, 1);
                    guacDisplay.scale(scale);
                }
            });

            // === LATENCY MEASUREMENT ===
            let lastPingTime = Date.now();
            let latencySamples = [];

            // Measure latency based on sync frequency
            setInterval(() => {
                const now = Date.now();
                const sinceLast = now - lastPingTime;

                // Only update if we've gotten syncs recently
                if (syncCount > 0) {
                    latencySamples.push(sinceLast);
                    if (latencySamples.length > 10) latencySamples.shift();

                    const avgLatency = Math.round(latencySamples.reduce((a, b) => a + b, 0) / latencySamples.length);

                    const latencyValue = document.getElementById('latency-value');
                    const latencyDot = document.getElementById('latency-dot');

                    latencyValue.textContent = avgLatency + ' ms';

                    // Color based on latency
                    if (avgLatency < 100) {
                        latencyDot.style.background = '#00ff00'; // Green - excellent
                    } else if (avgLatency < 200) {
                        latencyDot.style.background = '#ffff00'; // Yellow - good
                    } else if (avgLatency < 400) {
                        latencyDot.style.background = '#ffa500'; // Orange - fair
                    } else {
                        latencyDot.style.background = '#ff0000'; // Red - poor
                    }
                }
                lastPingTime = now;
            }, 1000);
        }

        // ========================================
        // UI Logic
        // ========================================
        function switchMode(mode) {
            const guacView = document.getElementById('guacamole-view');
            const parsecView = document.getElementById('parsec-view');
            // Check if RustDesk view exists (we might need to create it dynamically)
            let rustdeskView = document.getElementById('rustdesk-view');

            if (mode === 'rustdesk' && !rustdeskView) {
                // Create container if not exists
                rustdeskView = document.createElement('div');
                rustdeskView.id = 'rustdesk-view';
                rustdeskView.className = 'connection-instructions';
                document.querySelector('.workspace').appendChild(rustdeskView);
            }

            const btnNative = document.getElementById('btn-native');
            const btnParsec = document.getElementById('btn-parsec');
            const btnRustdesk = document.getElementById('btn-rustdesk');

            // Reset all
            guacView.style.display = 'none';
            parsecView.style.display = 'none';
            if (rustdeskView) rustdeskView.style.display = 'none';

            btnNative.classList.remove('active');
            btnParsec.classList.remove('active');
            if (btnRustdesk) btnRustdesk.classList.remove('active');

            if (mode === 'native') {
                guacView.style.display = 'flex';
                btnNative.classList.add('active');
                // Re-focus keyboard
                if (window.keyboard) window.keyboard.reset();
            } else if (mode === 'parsec') {
                parsecView.style.display = 'flex';
                btnParsec.classList.add('active');
            } else if (mode === 'rustdesk') {
                if (rustdeskView) rustdeskView.style.display = 'flex';
                if (btnRustdesk) btnRustdesk.classList.add('active');

                // Show content if empty
                if (rustdeskView && !rustdeskView.innerHTML) {
                    // Logic handled by initSession, or we re-render here
                    const booking = window.currentBooking; // We need to store this
                    if (booking && booking.computer?.rustdeskId) {
                        connectRustDesk(booking.computer.rustdeskId, booking.computer.rustdeskPassword);
                    }
                }
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;

                const date = new Date(elapsed);
                const h = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
                const m = String(date.getUTCMinutes()).padStart(2, '0');
                const s = String(date.getUTCSeconds()).padStart(2, '0');

                document.getElementById('sessionTimer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        async function endSession() {
            if (!confirm('驴Terminar sesi贸n?')) return;

            try {
                if (guacClient) guacClient.disconnect();

                await apiRequest(`/bookings/${booking.id}/end`, { method: 'POST' });
                window.location.href = 'profile.html';
            } catch (e) {
                console.error(e);
                window.location.href = 'profile.html';
            }
        }

        // Cleanup
        window.onbeforeunload = function () {
            if (guacClient) guacClient.disconnect();
        };

        // Global Debug Helper
        function createDebugOverlay() {
            const div = document.createElement('div');
            div.id = 'debug-overlay';
            div.style.cssText = 'position:fixed; top:60px; left:10px; background:rgba(0,0,0,0.8); color:#0f0; padding:10px; border:1px solid #0f0; font-family:monospace; z-index:9999; max-width:300px; pointer-events:none;';
            document.body.appendChild(div);
            return div;
        }

    </script>
</body>

</html>