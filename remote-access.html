<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi贸n Remota - DeskShare</title>
    <!-- Guacamole Client Library - v1.3.0 for guacamole-lite 1.2.0 compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/guacamole-common-js@1.3.0/dist/guacamole-common.min.js"></script>
    <script src="js/webrtc-viewer.js"></script> <!-- NEW: WebRTC Viewer Module -->
    <link rel="stylesheet" href="styles.css">
    <style>
        .remote-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .remote-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
        }

        .session-info {
            color: white;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .toggle-container {
            background: #333;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-purple);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-end {
            background: #ff4444;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end:hover {
            background: #cc0000;
        }

        /* DISPLAY AREAS */
        .workspace {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* GUACAMOLE */
        #guacamole-view {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: none;
            /* Hide cursor when interacting */
        }

        #display {
            /* Canvas container */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* WEBRTC */
        #webrtc-view {
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: #111;
        }

        #webrtc-canvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* PARSEC */
        #parsec-view {
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .connection-instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 10px;
            color: white;
            max-width: 600px;
            text-align: center;
            border: 1px solid #333;
        }

        .parsec-code {
            background: rgba(102, 126, 234, 0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 20px 0;
            border: 1px dashed #667eea;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="remote-container">
        <!-- Header -->
        <div class="remote-header">
            <div class="session-info">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size: 0.8rem; opacity: 0.7;">Conectado a</span>
                    <strong id="computerName">Cargando...</strong>
                </div>

                <div class="toggle-container">
                    <button class="toggle-btn active" onclick="switchMode('native')" id="btn-native">Guacamole</button>
                    <button class="toggle-btn" onclick="switchMode('webrtc')" id="btn-webrtc">WebRTC</button>
                    <button class="toggle-btn" onclick="switchMode('parsec')" id="btn-parsec">Parsec</button>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <!-- LATENCY PANEL -->
                <div id="latency-panel"
                    style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px;">
                    <div id="latency-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #00ff00;">
                    </div>
                    <div style="text-align: center; color: #ccc;">
                        <div style="font-size: 0.7rem; opacity: 0.7;">Latencia</div>
                        <div id="latency-value" style="font-weight: 700; color: white; font-size: 0.9rem;">-- ms</div>
                    </div>
                </div>

                <div style="text-align: right; color: #ccc;">
                    <div style="font-size: 0.8rem;">Tiempo</div>
                    <div id="sessionTimer" style="font-weight: 700; color:white;">00:00:00</div>
                </div>
                <button class="btn-end" onclick="endSession()">Desconectar</button>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace">

            <!-- VIEW 1: GUACAMOLE (Default) -->
            <div id="guacamole-view">
                <div id="display"></div>
            </div>

            <!-- VIEW 2: WEBRTC -->
            <div id="webrtc-view">
                <canvas id="webrtc-canvas"></canvas>
                <div id="connection-status"
                    style="position: absolute; top: 10px; left: 10px; color: yellow; background: rgba(0,0,0,0.5); padding: 5px;">
                    Esperando conexi贸n...
                </div>
            </div>

            <!-- VIEW 3: PARSEC -->
            <div id="parsec-view">
                <div class="connection-instructions">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h2>Modo Alto Rendimiento</h2>
                    <p style="opacity: 0.7;">Ideal para gaming o edici贸n de video usando la app de Parsec.</p>

                    <div id="parsecInfo" style="display: none; margin-top: 20px;">
                        <p>C贸digo de Acceso:</p>
                        <div class="parsec-code" id="parsecCode">---</div>
                        <p><a href="https://parsec.app/" target="_blank" style="color: var(--accent-purple);">Abrir
                                Parsec App</a></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let booking = null;
        let startTime = null;
        let timerInterval = null;
        let pricePerHour = 0;

        // Guacamole Vars
        let guacClient = null;
        let guacDisplay = null;
        let mouse = null;
        let keyboard = null;

        // WebRTC Vars
        let webrtcViewer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return; // script.js function

            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            if (!bookingId) {
                alert('ID de booking inv谩lido');
                window.location.href = 'marketplace.html';
                return;
            }

            await initializeSession(bookingId);
        });

        async function initializeSession(bookingId) {
            try {

                // DEBUG: Direct fetch to bypass cache/script.js issues
                const token = localStorage.getItem('authToken');
                const backendUrl = 'https://deskshare-backend-production.up.railway.app/api';

                const response = await fetch(`${backendUrl}/bookings/${bookingId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // SHOW FULL ERROR JSON
                    alert(`DEBUG ERROR:\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`);
                    // Don't redirect immediately so user can read
                    return;
                }

                // Success flow
                booking = data.booking;
                window.currentBooking = booking; // Store for mode switching

                // DEBUG: Show Connection Strategy
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:yellow; border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px;">Strategy: ${data.connectionStrategy}</div>`;
                if (data.connectionDebug) {
                    debugOverlay.innerHTML += `<div style="font-size:0.8rem; color:#888;">${data.connectionDebug}</div>`;
                }

                // Update UI
                document.getElementById('computerName').textContent = booking.computer?.name || 'PC Remota';
                pricePerHour = booking.priceAgreed;
                startTime = new Date(); // Reset timer to now
                startTimer();

                // === CHECK FOR WEBRTC (P2P - LOW LATENCY) ===
                // NOTE: We now enable WebRTC button properly if capable
                const webrtcCapable = booking.computer?.webrtcCapable;
                const webrtcMode = booking.computer?.webrtcMode; // 'native' or 'browser'

                if (webrtcCapable) {
                    console.log('[WEBRTC] P2P connection available (mode:', webrtcMode, ')');

                    const btnWebrtc = document.getElementById('btn-webrtc');
                    if (btnWebrtc) {
                        btnWebrtc.style.display = 'flex';
                        // Keep label simple as per user request
                        btnWebrtc.textContent = 'WebRTC';
                    }

                    const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                    debugOverlay.innerHTML += `<div style="color:lime;"> WebRTC P2P: ${webrtcMode}</div>`;
                }

                // ALWAYS SHOW WEBRTC BUTTON FOR DEBUGGING (Development)
                document.getElementById('btn-webrtc').style.display = 'flex';


                // === CONNECT GUACAMOLE (FALLBACK/DEFAULT) ===
                const guacToken = data.guacamoleToken;
                if (guacToken) {
                    connectGuacamole(guacToken);
                } else {
                    // If no token (maybe no RDP configured), switch to Parsec
                    alert('No se detect贸 configuraci贸n RDP/VNC. Cambiando a modo Parsec.');
                    switchMode('parsec');
                }

                // 3. Setup Parsec Info (Just in case user switches)
                if (booking.computer?.parsecPeerId) {
                    document.getElementById('parsecCode').textContent = booking.accessToken ? 'Ver en Chat' : 'Auto-Connect';
                    document.getElementById('parsecInfo').style.display = 'block';
                }

            } catch (error) {
                console.error('Critical Session Error:', error);
                alert('Critical Error: ' + error.message);
            }
        }

        // ========================================
        // UI Logic
        // ========================================
        function switchMode(mode) {
            const guacView = document.getElementById('guacamole-view');
            const parsecView = document.getElementById('parsec-view');
            const webrtcView = document.getElementById('webrtc-view');

            const btnNative = document.getElementById('btn-native');
            const btnParsec = document.getElementById('btn-parsec');
            const btnWebrtc = document.getElementById('btn-webrtc');

            // Reset all
            guacView.style.display = 'none';
            parsecView.style.display = 'none';
            if (webrtcView) webrtcView.style.display = 'none';

            btnNative.classList.remove('active');
            btnParsec.classList.remove('active');
            btnWebrtc.classList.remove('active');

            if (mode === 'native') {
                guacView.style.display = 'flex';
                btnNative.classList.add('active');
                if (window.keyboard) window.keyboard.reset();

            } else if (mode === 'parsec') {
                parsecView.style.display = 'flex';
                btnParsec.classList.add('active');

            } else if (mode === 'webrtc') {
                if (webrtcView) webrtcView.style.display = 'flex';
                btnWebrtc.classList.add('active');

                // Initialize WebRTC if not already running
                if (!webrtcViewer && window.currentBooking) {
                    console.log('Initializing WebRTC Viewer...');
                    webrtcViewer = new WebRTCViewer('webrtc-canvas', window.currentBooking);
                    webrtcViewer.connect().catch(err => {
                        console.error('WebRTC Start Failed:', err);
                        alert('Error iniciando WebRTC: ' + err.message);
                    });
                }
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;

                const date = new Date(elapsed);
                const h = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
                const m = String(date.getUTCMinutes()).padStart(2, '0');
                const s = String(date.getUTCSeconds()).padStart(2, '0');

                document.getElementById('sessionTimer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        async function endSession() {
            if (!confirm('驴Terminar sesi贸n?')) return;

            try {
                if (guacClient) guacClient.disconnect();

                await apiRequest(`/bookings/${booking.id}/end`, { method: 'POST' });
                window.location.href = 'profile.html';
            } catch (e) {
                console.error(e);
                window.location.href = 'profile.html';
            }
        }

        // Cleanup
        window.onbeforeunload = function () {
            if (guacClient) guacClient.disconnect();
        };

        // Global Debug Helper
        function createDebugOverlay() {
            const div = document.createElement('div');
            div.id = 'debug-overlay';
            div.style.cssText = 'position:fixed; top:60px; left:10px; background:rgba(0,0,0,0.8); color:#0f0; padding:10px; border:1px solid #0f0; font-family:monospace; z-index:9999; max-width:300px; pointer-events:none;';
            document.body.appendChild(div);
            return div;
        }

    </script>
</body>

</html>