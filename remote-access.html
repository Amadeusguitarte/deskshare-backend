<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesi贸n Remota - DeskShare v1.2</title>
    <!-- Guacamole Client Library (Local) -->
    <script src="js/guacamole-common.js"></script>
    <script src="js/webrtc-viewer.js"></script> <!-- NEW: WebRTC Viewer Module -->
    <link rel="stylesheet" href="styles.css">
    <style>
        .remote-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        .remote-header {
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
        }

        .session-info {
            color: white;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .toggle-container {
            background: #333;
            border-radius: 20px;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 16px;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: #aaa;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-purple);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .btn-end {
            background: #ff4444;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-end:hover {
            background: #cc0000;
        }

        /* DISPLAY AREAS */
        .workspace {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            overflow: hidden;
        }

        /* GUACAMOLE */
        #guacamole-view {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: none;
            /* Hide cursor when interacting */
        }

        #display {
            /* Canvas container */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* WEBRTC */
        #webrtc-view {
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: #111;
        }

        #webrtc-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background: #000;
        }

        /* PARSEC */
        #parsec-view {
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .connection-instructions {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 10px;
            color: white;
            max-width: 600px;
            text-align: center;
            border: 1px solid #333;
        }

        .parsec-code {
            background: rgba(102, 126, 234, 0.2);
            padding: 15px;
            border-radius: 8px;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 4px;
            margin: 20px 0;
            border: 1px dashed #667eea;
            font-family: monospace;
        }

        .hidden-force {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="remote-container">
        <!-- Header -->
        <div class="remote-header">
            <div class="session-info">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size: 0.8rem; opacity: 0.7;">Conectado a</span>
                    <strong id="computerName">Cargando...</strong>
                </div>

                <div class="toggle-container" style="display: none;">
                    <button class="toggle-btn active" onclick="switchMode('webrtc')" id="btn-webrtc">WebRTC</button>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <!-- LATENCY PANEL -->
                <div id="latency-panel"
                    style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 6px 12px; border-radius: 20px;">
                    <div id="latency-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #00ff00;">
                    </div>
                    <div style="text-align: center; color: #ccc;">
                        <div style="font-size: 0.7rem; opacity: 0.7;">Latencia</div>
                        <div id="latency-value" style="font-weight: 700; color: white; font-size: 0.9rem;">-- ms</div>
                    </div>
                </div>

                <div style="text-align: right; color: #ccc;">
                    <div style="font-size: 0.8rem;">Tiempo</div>
                    <div id="sessionTimer" style="font-weight: 700; color:white;">00:00:00</div>
                </div>
                <button class="btn-end" onclick="endSession()">Desconectar</button>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="workspace">


            <!-- VIEW 2: WEBRTC -->
            <div id="webrtc-view">
                <canvas id="webrtc-canvas"></canvas>
                <div id="connection-status"
                    style="position: absolute; top: 10px; left: 10px; color: #0ff; background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 4px; border: 1px solid #333; font-family: monospace; display: flex; align-items: center; gap: 15px;">
                    <div> P2P: <span id="webrtc-state">Iniciando...</span></div>
                    <button onclick="if(webrtcViewer) webrtcViewer.toggleFullscreen()"
                        style="background: #333; color: white; border: 1px solid #555; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                        Pantalla Completa
                    </button>
                </div>
            </div>

            <!-- VIEW 3: PARSEC -->
            <div id="parsec-view">
                <div class="connection-instructions">
                    <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                    <h2>Modo Alto Rendimiento</h2>
                    <p style="opacity: 0.7;">Ideal para gaming o edici贸n de video usando la app de Parsec.</p>

                    <div id="parsecInfo" style="display: none; margin-top: 20px;">
                        <p>C贸digo de Acceso:</p>
                        <div class="parsec-code" id="parsecCode">---</div>
                        <p><a href="https://parsec.app/" target="_blank" style="color: var(--accent-purple);">Abrir
                                Parsec App</a></p>
                    </div>
                </div>
            </div>

        </div>

        <!-- CHAT WIDGET CONTAINER -->
        <div id="chatWidgetContainer"></div>
    </div>

    <!-- Global Dependencies -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="script.js"></script>
    <script src="js/chat-manager.js"></script>
    <script>
        let booking = null;
        let startTime = null;
        let timerInterval = null;
        let pricePerHour = 0;

        // Guacamole Vars
        let guacClient = null;
        let guacDisplay = null;
        let mouse = null;
        let keyboard = null;

        // WebRTC Vars
        let webrtcViewer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return; // script.js function

            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            if (!bookingId) {
                alert('ID de booking inv谩lido');
                window.location.href = 'marketplace.html';
                return;
            }

            await initializeSession(bookingId);
        });

        async function initializeSession(bookingId) {
            try {

                // DEBUG: Direct fetch to bypass cache/script.js issues
                const token = localStorage.getItem('authToken');
                const backendUrl = 'https://deskshare-backend-production.up.railway.app/api';

                const response = await fetch(`${backendUrl}/bookings/${bookingId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // SHOW FULL ERROR JSON
                    alert(`DEBUG ERROR:\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`);
                    // Don't redirect immediately so user can read
                    return;
                }

                // Success flow
                booking = data.booking;
                window.currentBooking = booking; // Store for mode switching

                // DEBUG: Show Connection Strategy
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:yellow; border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px;">Strategy: ${data.connectionStrategy}</div>`;
                if (data.connectionDebug) {
                    debugOverlay.innerHTML += `<div style="font-size:0.8rem; color:#888;">${data.connectionDebug}</div>`;
                }

                // Update UI
                document.getElementById('computerName').textContent = booking.computer?.name || 'PC Remota';
                pricePerHour = booking.priceAgreed;
                startTime = new Date(); // Reset timer to now
                startTimer();

                // ALWAYS switch to WebRTC Mode (Pure WebRTC Experience)
                switchMode('webrtc');

                // INITIALIZE CHAT (Fixing Key in v8.0)
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (user && !window.chatManager) {
                    const socketUrl = 'https://deskshare-backend-production.up.railway.app';
                    window.chatManager = new ChatManager(user, socketUrl);
                }

            } catch (error) {
                console.error('Critical Session Error:', error);
                // Only alert if we haven't handled it (e.g. not in WebRTC mode)
                alert('Critical Error: ' + error.message);
            }
        }

        // ========================================
        // Guacamole Logic
        // ========================================
        function connectGuacamole(token) {
            const displayContainer = document.getElementById('display');

            // Hardcoded Backend for Production (Railway)
            const tunnelUrl = 'wss://deskshare-backend-production.up.railway.app/guacamole';

            const tunnel = new Guacamole.WebSocketTunnel(`${tunnelUrl}?token=${token}`);
            guacClient = new Guacamole.Client(tunnel);

            guacClient.onerror = function (error) {
                console.error('Guacamole Client Error:', error);
                const msg = error.message || error.toString();
                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div style="color:red">Error: ${msg}</div>`;
                alert('Guacamole Error: ' + msg);
            };

            guacClient.onstatechange = function (state) {
                const states = {
                    0: 'IDLE',
                    1: 'CONNECTING',
                    2: 'WAITING',
                    3: 'CONNECTED',
                    4: 'DISCONNECTING',
                    5: 'DISCONNECTED'
                };
                const stateStr = states[state] || state;
                console.log('Guacamole State:', stateStr);

                const debugOverlay = document.getElementById('debug-overlay') || createDebugOverlay();
                debugOverlay.innerHTML += `<div>State: ${stateStr}</div>`;

                if (state === 3) {
                    debugOverlay.style.display = 'none';
                }
            };

            guacDisplay = guacClient.getDisplay();
            const element = guacDisplay.getElement();
            displayContainer.appendChild(element);

            let syncCount = 0;
            guacClient.onsync = function () {
                syncCount++;
                const displayWidth = guacDisplay.getWidth();
                const displayHeight = guacDisplay.getHeight();

                if (syncCount === 1 || syncCount % 10 === 0) {
                    console.log(`[GUAC] onsync #${syncCount} - Display: ${displayWidth}x${displayHeight}`);
                }

                if (displayWidth > 0 && displayHeight > 0) {
                    const containerWidth = displayContainer.offsetWidth;
                    const containerHeight = displayContainer.offsetHeight;
                    const scaleX = containerWidth / displayWidth;
                    const scaleY = containerHeight / displayHeight;
                    const scale = Math.min(scaleX, scaleY, 1);
                    guacDisplay.scale(scale);
                }
            };

            guacClient.connect();

            mouse = new Guacamole.Mouse(element);
            mouse.onmousedown = mouse.onmouseup = mouse.onmousemove = function (mouseState) {
                const scale = guacDisplay.getScale();
                mouseState.x = mouseState.x / scale;
                mouseState.y = mouseState.y / scale;
                guacClient.sendMouseState(mouseState);
            };

            keyboard = new Guacamole.Keyboard(document);
            keyboard.onkeydown = function (keysym) {
                guacClient.sendKeyEvent(1, keysym);
            };
            keyboard.onkeyup = function (keysym) {
                guacClient.sendKeyEvent(0, keysym);
            };

            window.onblur = function () { keyboard.reset(); };

            window.addEventListener('resize', () => {
                if (guacDisplay && guacDisplay.getWidth() > 0) {
                    const containerWidth = displayContainer.offsetWidth;
                    const containerHeight = displayContainer.offsetHeight;
                    const displayWidth = guacDisplay.getWidth();
                    const displayHeight = guacDisplay.getHeight();
                    const scaleX = containerWidth / displayWidth;
                    const scaleY = containerHeight / displayHeight;
                    const scale = Math.min(scaleX, scaleY, 1);
                    guacDisplay.scale(scale);
                }
            });

            // Real Latency (via HTTP Ping to Backend)
            setInterval(async () => {
                const latencyVal = document.getElementById('latency-value');
                const latencyDot = document.getElementById('latency-dot');

                try {
                    const start = Date.now();
                    await fetch('https://deskshare-backend-production.up.railway.app/api/health', { cache: 'no-store' });
                    const latency = Date.now() - start;

                    if (latencyVal) latencyVal.textContent = latency + ' ms';

                    if (latencyDot) {
                        if (latency < 150) latencyDot.style.backgroundColor = '#00ff00';
                        else if (latency < 400) latencyDot.style.backgroundColor = '#ffff00';
                        else latencyDot.style.backgroundColor = '#ff0000';
                    }
                } catch (e) {
                    if (latencyVal) latencyVal.textContent = '-- ms';
                    if (latencyDot) latencyDot.style.backgroundColor = '#666';
                }
            }, 3000);
        }

        // ========================================
        // RustDesk Logic
        // ========================================
        function connectRustDesk(rustdeskId, password) {
            const displayContainer = document.getElementById('display');
            displayContainer.innerHTML = `<div style="color:white;text-align:center;padding:50px;"><h2>RustDesk P2P</h2><p>Abriendo app...</p></div>`;
            setTimeout(() => openRustDeskApp(rustdeskId, password), 1500);
        }

        function openRustDeskApp(rustdeskId, password) {
            window.location.href = `rustdesk://connection/new/${rustdeskId}?password=${password}`;
        }

        // ========================================
        // UI Logic
        // ========================================
        function switchMode(mode) {
            const webrtcView = document.getElementById('webrtc-view');
            const btnWebrtc = document.getElementById('btn-webrtc');
            const debugOverlay = document.getElementById('debug-overlay');

            // Hide all potential views (Null-safe)
            ['guacamole-view', 'parsec-view', 'webrtc-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            if (debugOverlay) {
                if (mode === 'webrtc') debugOverlay.classList.add('hidden-force');
                else debugOverlay.classList.remove('hidden-force');
                debugOverlay.style.display = 'none';
            }

            if (mode === 'webrtc') {
                if (webrtcView) webrtcView.style.display = 'flex';
                if (btnWebrtc) btnWebrtc.classList.add('active');

                // AUDIO UNLOCK: When user clicks/interacts to switch to WebRTC (or initializing), unmute
                if (webrtcViewer) webrtcViewer.unmute();

                // Initialize WebRTC if not already running
                if (!webrtcViewer && window.currentBooking) {
                    console.log('Initializing WebRTC Viewer...');
                    webrtcViewer = new WebRTCViewer('webrtc-canvas', window.currentBooking);
                    webrtcViewer.connect().catch(err => {
                        console.error('WebRTC Start Failed:', err);
                        alert('Error iniciando WebRTC: ' + err.message);
                    });
                }
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;

                const date = new Date(elapsed);
                const h = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
                const m = String(date.getUTCMinutes()).padStart(2, '0');
                const s = String(date.getUTCSeconds()).padStart(2, '0');

                document.getElementById('sessionTimer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        async function endSession() {
            if (!confirm('驴Terminar sesi贸n?')) return;

            try {
                if (guacClient) guacClient.disconnect();

                await apiRequest(`/bookings/${booking.id}/end`, { method: 'POST' });
                window.location.href = 'profile.html';
            } catch (e) {
                console.error(e);
                window.location.href = 'profile.html';
            }
        }

        // Cleanup
        window.onbeforeunload = function () {
            if (guacClient) guacClient.disconnect();
        };

        // Global Debug Helper
        function createDebugOverlay() {
            const div = document.createElement('div');
            div.id = 'debug-overlay';
            div.style.cssText = 'position:fixed; top:60px; left:10px; background:rgba(0,0,0,0.8); color:#0f0; padding:10px; border:1px solid #0f0; font-family:monospace; z-index:9999; max-width:300px; pointer-events:none;';
            document.body.appendChild(div);
            return div;
        }

    </script>
</body>

</html>