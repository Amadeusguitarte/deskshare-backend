# Nixpacks Configuration for DeskShare Backend + Guacamole
# This allows us to run 'guacd' and 'node' in the same container easily.

[phases.setup]
# we need nodejs for the app, and standard tools to run guacd
nixPkgs = ["nodejs-18_x", "guacamole-server", "freerdp", "libvncserver", "busybox", "cloudflared"]

[phases.install]
cmds = ["npm ci"]

[phases.build]
cmds = ["npx prisma generate"]

[start]
# 1. Start guacd in foreground but backgrounded with &
# 2. Wait a moment for guacd to initialize
# 3. Run Prisma push
# 4. Start Node server
cmd = "guacd -f -L info & sleep 2 && npx prisma db push --accept-data-loss && node server.js"
