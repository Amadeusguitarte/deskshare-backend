<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 10000;
        overflow-y: auto;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-content {
        background: #1a1a2e;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .modal-header h2 {
        margin: 0;
    }

    .close-modal {
        background: none;
        border: none;
        font-size: 2rem;
        color: #fff;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #fff;
        font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: #fff;
        font-size: 1rem;
    }

    .form-group select option {
        background: #1a1a2e;
        color: #fff;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-purple);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .file-upload {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload:hover {
        border-color: var(--primary-purple);
        background: rgba(138, 43, 226, 0.05);
    }

    .file-upload input {
        display: none;
    }

    .image-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
        min-height: 0;
    }

    .image-preview img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid rgba(138, 43, 226, 0.3);
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .modal-content {
            padding: 30px 20px;
        }
    }
</style>

<div id="addComputerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìù Publicar Nueva Computadora</h2>
            <button class="close-modal" onclick="closeAddComputerModal()">&times;</button>
        </div>

        <form id="addComputerForm">
            <div class="form-group">
                <label for="computerName">Nombre *</label>
                <input type="text" id="computerName" required placeholder="Ej: Workstation Profesional">
            </div>

            <div class="form-group">
                <label for="computerDescription">Descripci√≥n *</label>
                <textarea id="computerDescription" required placeholder="Describe tu computadora..."></textarea>
            </div>

            <div class="form-group">
                <label for="computerCategory">Categor√≠a *</label>
                <select id="computerCategory" required>
                    <option value="">Seleccionar...</option>
                    <option value="Gaming">Gaming</option>
                    <option value="Workstation">Workstation</option>
                    <option value="Mining">Mining</option>
                    <option value="Development">Development</option>
                    <option value="Rendering">Rendering</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="computerCPU">CPU *</label>
                    <input type="text" id="computerCPU" required placeholder="Ej: i9-13900K">
                </div>

                <div class="form-group">
                    <label for="computerGPU">GPU *</label>
                    <input type="text" id="computerGPU" required placeholder="Ej: RTX 4090">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="computerRAM">RAM (GB) *</label>
                    <input type="number" id="computerRAM" required placeholder="64">
                </div>

                <div class="form-group">
                    <label for="computerStorage">Storage (GB) *</label>
                    <input type="number" id="computerStorage" required placeholder="2000">
                </div>
            </div>

            <div class="form-group">
                <label for="computerPrice">Precio por Hora ($) *</label>
                <input type="number" step="0.01" id="computerPrice" required placeholder="8.00">
            </div>

            <div class="form-group">
                <label>Im√°genes</label>
                <div class="file-upload" onclick="document.getElementById('computerImages').click()">
                    <p>üì∏ Click para subir im√°genes</p>
                    <input type="file" id="computerImages" accept="image/*" multiple>
                </div>
                <div id="imagePreview" class="image-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                Publicar Computadora
            </button>
        </form>
    </div>
</div>

<script>
    function closeAddComputerModal() {
        document.getElementById('addComputerModal').classList.remove('show');
        document.getElementById('addComputerForm').reset();
        document.getElementById('imagePreview').innerHTML = '';
    }

    // Image preview
    document.getElementById('computerImages')?.addEventListener('change', function (e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';

        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    // Form submission
    document.getElementById('addComputerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!checkAuth()) {
            alert('Debes iniciar sesi√≥n para publicar una computadora');
            window.location.href = 'login.html';
            return;
        }

        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Publicando...';

        try {
            // Upload images first
            const imageFiles = document.getElementById('computerImages').files;
            const imageUrls = [];

            if (imageFiles.length > 0) {
                for (let file of imageFiles) {
                    const formData = new FormData();
                    formData.append('image', file);

                    const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });

                    const uploadData = await uploadResponse.json();
                    if (uploadData.url) {
                        imageUrls.push({ url: uploadData.url, isPrimary: imageUrls.length === 0 });
                    }
                }
            }

            // Create computer listing
            const computerData = {
                name: document.getElementById('computerName').value,
                description: document.getElementById('computerDescription').value,
                category: document.getElementById('computerCategory').value,
                cpu: document.getElementById('computerCPU').value,
                gpu: document.getElementById('computerGPU').value,
                ram: parseInt(document.getElementById('computerRAM').value),
                storage: parseInt(document.getElementById('computerStorage').value),
                pricePerHour: parseFloat(document.getElementById('computerPrice').value),
                images: imageUrls
            };

            const response = await apiRequest('/computers', {
                method: 'POST',
                body: JSON.stringify(computerData)
            });

            alert('¬°Computadora publicada exitosamente!');
            closeAddComputerModal();
            window.location.href = 'profile.html';

        } catch (error) {
            alert('Error al publicar la computadora: ' + error.message);
        } finally {
            button.disabled = false;
            button.textContent = 'Publicar Computadora';
        }
    });
</script>